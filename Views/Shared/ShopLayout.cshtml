@using Microsoft.AspNetCore.Http
@{
    var userName = Context.Session.GetString("UserName");
    var isLoggedIn = !string.IsNullOrWhiteSpace(userName);

    // simple cart badge from session json (optional UI)
    var cartJson = Context.Session.GetString("CART");
    var cartCount = 0;
    if (!string.IsNullOrEmpty(cartJson))
    {
        cartCount = cartJson.Split("\"ProductId\"").Length - 1;
        if (cartCount < 0) { cartCount = 0; }
    }
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewBag.Title</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --bg: #0b1220;
            --card: rgba(255,255,255,.08);
            --border: rgba(255,255,255,.14);
            --soft: rgba(15, 23, 42, .08);
        }

        body {
            font-family: Inter, sans-serif;
            background: #f6f7fb;
        }

        /* ===== HEADER ===== */
        .topbar {
            background: radial-gradient(900px 400px at 10% 10%, rgba(99,102,241,.35), transparent 60%), radial-gradient(900px 400px at 90% 20%, rgba(34,197,94,.25), transparent 60%), linear-gradient(135deg, #0b1220, #0f172a);
            color: #fff;
        }

            .topbar .brand-badge {
                width: 42px;
                height: 42px;
                border-radius: 14px;
                display: grid;
                place-items: center;
                background: linear-gradient(135deg,#ff7a18,#af002d 50%,#319197);
                box-shadow: 0 10px 25px rgba(0,0,0,.25);
            }

        .glass {
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.16);
            backdrop-filter: blur(10px);
        }

        .nav-pill {
            border-radius: 999px;
            padding: .45rem .9rem;
            color: rgba(255,255,255,.85);
            text-decoration: none;
            display: flex;
            gap: .45rem;
            align-items: center;
        }

            .nav-pill:hover {
                background: rgba(255,255,255,.10);
                color: #fff;
            }

        .search-wrap {
            border-radius: 999px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,.18);
        }

            .search-wrap input {
                border: 0;
            }

            .search-wrap .input-group-text {
                border: 0;
                background: #fff;
            }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            background: rgba(255,255,255,.10);
            border: 1px solid rgba(255,255,255,.16);
            color: #fff;
            text-decoration: none;
        }

            .icon-btn:hover {
                background: rgba(255,255,255,.14);
            }

        .badge-dot {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 999px;
            background: #ff3d71;
            color: #fff;
            font-size: 12px;
            display: grid;
            place-items: center;
            border: 2px solid rgba(11,18,32,.9);
        }

        /* Location pill */
        .loc-pill {
            cursor: pointer;
            border-radius: 16px;
            padding: .45rem .65rem;
            display: flex;
            align-items: center;
            gap: .55rem;
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.16);
            max-width: 250px;
        }

            .loc-pill:hover {
                background: rgba(255,255,255,.12);
            }

        .loc-lines {
            line-height: 1.05;
            min-width: 0;
        }

        .loc-top {
            font-size: .78rem;
            color: rgba(255,255,255,.68);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loc-bottom {
            font-weight: 800;
            font-size: .92rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== FOOTER ===== */
        .footer-wrap {
            background: radial-gradient(900px 400px at 20% 20%, rgba(168,85,247,.18), transparent 60%), radial-gradient(900px 400px at 80% 0%, rgba(59,130,246,.18), transparent 55%), linear-gradient(180deg, #0b1220, #0f172a);
            color: #cbd5e1;
        }

        .footer-card {
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 18px;
            padding: 18px;
        }

        .footer-link {
            color: rgba(226,232,240,.85);
            text-decoration: none;
        }

            .footer-link:hover {
                color: #fff;
                text-decoration: underline;
            }

        .social {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            color: #fff;
            text-decoration: none;
        }

            .social:hover {
                background: rgba(255,255,255,.10);
            }

        main.container {
            min-height: 62vh;
        }

        ..page-bg {
            background-color: #ddd !important;
        }




    </style>
</head>

<body>

    <header class="topbar sticky-top">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">

                <!-- Brand -->
                <a class="d-flex align-items-center gap-2 text-decoration-none text-white" href="@Url.Action("Index", "Shop")">
                    <span class="brand-badge"><i class="bi bi-bag-heart-fill fs-5"></i></span>
                    <div class="lh-sm">
                        <div class="fw-bold fs-5">RoundPay Mart</div>
                        <div class="small text-white-50">Deals • New arrivals • Fast checkout</div>
                    </div>
                </a>

                <!-- Delivering to -->
                <div class="loc-pill" data-bs-toggle="modal" data-bs-target="#rpLocationModal" title="Change delivery location">
                    <i class="bi bi-geo-alt fs-5"></i>
                    <div class="loc-lines">
                        <div class="loc-top" id="rpDeliverTop">Delivering to</div>
                        <div class="loc-bottom" id="rpDeliverBottom">Select Pincode</div>
                    </div>
                </div>

                <!-- Search -->
                <form class="flex-grow-1" style="max-width:520px;" asp-controller="Shop" asp-action="Index" method="get">
                    <div class="input-group search-wrap">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input class="form-control" type="search" name="q" value="@(ViewBag.Search ?? "")" placeholder="Search products, brands..." />
                        <button class="btn btn-dark" type="submit"><i class="bi bi-arrow-right"></i></button>
                    </div>
                </form>

                <!-- Right -->
                <div class="d-flex align-items-center gap-2">

                    <a class="icon-btn position-relative" href="@Url.Action("Cart", "Shop")" title="Cart">
                        <i class="bi bi-cart3 fs-5"></i>
                        @if (cartCount > 0)
                        {
                            <span class="badge-dot">@cartCount</span>
                        }
                    </a>

                    @if (!isLoggedIn)
                    {
                        <a class="icon-btn" href="@Url.Action("Login", "LoginPanel")" title="Login">
                            <i class="bi bi-box-arrow-in-right fs-5"></i>
                        </a>
                    }
                    else
                    {
                        <div class="dropdown">
                            <a class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i> Account
                            </a>

                            <ul class="dropdown-menu dropdown-menu-end shadow rounded-3">

                                <!-- Account -->
                                <li>
                                    <a class="dropdown-item" href="/Shop/Profile">
                                        <i class="bi bi-person me-2"></i> My Account
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="/Shop/Orders">
                                        <i class="bi bi-box-seam me-2"></i> Orders
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="/Shop/Wishlist">
                                        <i class="bi bi-heart me-2"></i> Wishlist
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="/Shop/Wallet">
                                        <i class="bi bi-wallet2 me-2"></i> Wallet
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="/Shop/CheckoutAddress">
                                        <i class="bi bi-geo-alt me-2"></i> Saved Addresses
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="/Shop/Profile">
                                        <i class="bi bi-shield-lock me-2"></i> Login & Security
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-bell me-2"></i> Notifications
                                    </a>
                                </li>

                                <li><hr class="dropdown-divider"></li>

                                <!-- Logout -->
                                <li>
                                    <a class="dropdown-item text-danger" href="/LoginPanel/Logout">
                                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                                    </a>
                                </li>

                            </ul>
                        </div>


                    }
                </div>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
                <a class="nav-pill glass" href="@Url.Action("New", "Shop")"><i class="bi bi-stars"></i> New</a>
                <a class="nav-pill glass" href="@Url.Action("Offers", "Shop")"><i class="bi bi-tags"></i> Offers</a>
                <a class="nav-pill glass" href="@Url.Action("Support", "Shop")"><i class="bi bi-headset"></i> Support</a>
            </div>
        </div>
    </header>

    <!-- Location Modal -->
    <div class="modal fade" id="rpLocationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Choose delivery location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Pincode</label>
                        <input id="rpPincodeInput" type="text" class="form-control" maxlength="6" placeholder="e.g. 110001">
                        <div class="form-text">We’ll remember this for next time.</div>
                    </div>

                    <div class="d-flex gap-2 flex-wrap mt-3">
                        <button class="btn btn-dark" type="button" onclick="rpSavePincode()"><i class="bi bi-check2-circle me-1"></i> Save</button>
                        <button class="btn btn-outline-primary" type="button" onclick="rpDetectLocation()">
                            <i class="bi bi-crosshair2 me-1"></i> Detect Location (optional)
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="rpClearLocation()"><i class="bi bi-x-circle me-1"></i> Clear</button>
                    </div>

                    <div class="small text-muted mt-3" id="rpLocStatus"></div>
                </div>
            </div>
        </div>
    </div>
    <main class="page-bg py-4">
        <div class="container">
            @RenderBody()
        </div>
    </main>


    <footer class="footer-wrap mt-5">
        <div class="container py-5">
            <div class="row g-4">
                <div class="col-12 col-lg-4">
                    <div class="footer-card">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="brand-badge" style="width:38px;height:38px;"><i class="bi bi-bag-heart-fill"></i></span>
                            <div class="fw-bold fs-5 text-white">RoundPay Mart</div>
                        </div>
                        <div class="small">End-to-end shopping workflow with real-time inventory management, order lifecycle tracking, and payment status integration.
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-2">
                    <div class="footer-card h-100">
                        <div class="fw-bold text-white mb-2">Shop</div>
                        <div class="d-flex flex-column gap-2 small">
                            <a class="footer-link" href="@Url.Action("Index", "Shop")">All Products</a>
                            <a class="footer-link" href="@Url.Action("New", "Shop")">New Arrivals</a>
                            <a class="footer-link" href="@Url.Action("Offers", "Shop")">Offers</a>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-2">
                    <div class="footer-card h-100">
                        <div class="fw-bold text-white mb-2">Account</div>
                        <div class="d-flex flex-column gap-2 small">
                            <a class="footer-link" href="@Url.Action("Profile", "Shop")">My Profile</a>
                            <a class="footer-link" href="@Url.Action("Orders", "Shop")">My Orders</a>
                            <a class="footer-link" href="@Url.Action("Cart", "Shop")">Cart</a>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="footer-card h-100">
                        <div class="fw-bold text-white mb-2">Contact</div>
                        <div class="small mb-3">
                            <div class="mb-2"><i class="bi bi-geo-alt me-2"></i>India</div>
                            <div class="mb-2"><i class="bi bi-envelope me-2"></i>RoundPaysupport.com</div>
                            <div class="mb-2"><i class="bi bi-telephone me-2"></i>+91 9580987041</div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-light opacity-25 my-4" />

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 small">
                <div>© @DateTime.Now.Year <span class="text-white fw-semibold">LoginPanel</span>. All rights reserved.</div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const RP_PIN_KEY = "rp_pincode";
        

        function rpSavePincode() {
            const el = document.getElementById("rpPincodeInput");
            const status = document.getElementById("rpLocStatus");
            const v = (el.value || "").trim();

            if (!/^\d{6}$/.test(v)) {
                status.innerText = "❌ Please enter valid 6-digit pincode";
                return;
            }

            localStorage.setItem(RP_PIN_KEY, v);
            rpSetHeaderLocation();
            status.innerText = "✅ Saved";
        }

            function rpClearLocation() {
            localStorage.removeItem(RP_PIN_KEY);
            document.getElementById("rpPincodeInput").value = "";
            document.getElementById("rpLocStatus").innerText = "Cleared.";
            rpSetHeaderLocation();
        }


                function rpDetectLocation() {
            const status = document.getElementById("rpLocStatus");

            if (!navigator.geolocation) {
                status.innerText = "❌ Geolocation not supported.";
                return;
            }

            status.innerText = "Detecting location…";
            navigator.geolocation.getCurrentPosition(
                () => {
                    status.innerText = "📍 Location detected. Please enter pincode.";
                },
                () => status.innerText = "❌ Permission denied.",
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }


        function rpSetHeaderLocation() {
            const bottom = document.getElementById("rpDeliverBottom");
            if (!bottom) return;

            // 🔹 1️⃣ Session Address (highest priority)
            @using System.Text.Json
            @using LoginPanel.Models
            @{
                    var addrJson = Context.Session.GetString("ADDR");
                    if (!string.IsNullOrEmpty(addrJson))
                    {
                            try
                            {
                                    var addr = JsonSerializer.Deserialize<CheckoutAddressVM>(addrJson);
                                    if (addr != null)
                                    {
                                            <text>
                                                bottom.innerText = "@addr.City - @addr.Pincode";
                                                return;
                                            </text>
                                    }
                            }
                            catch { }
                    }
            }

                // 🔹 2️⃣ localStorage fallback
        const pin = localStorage.getItem(RP_PIN_KEY);
        bottom.innerText = pin ? pin : "Select Pincode";


        }
            
        document.addEventListener("DOMContentLoaded", rpSetHeaderLocation);
    </script>

    @* ✅ THIS IS THE FIX FOR YOUR ERROR *@
    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>
